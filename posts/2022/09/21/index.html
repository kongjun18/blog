<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>什么是 tar - 孔俊的知识库</title><meta name=author content><meta name=author-link content><meta name=description content="tar 是 tape archive 的简称，即“磁带归档”，最早出现在 1979 年的第 UNIX v7。磁带上的数据存储为可能不相邻的变长数据块，浪费了大量块与块之间的空间。向磁盘、网络传输数据时，传输一大块的效率远高于多个小块，因此程序员使用 tar 将磁带上的数据打包在一起，物理上存储在连续的、固定大小的块上以提高性能。 tar 打包出来的文件称为为 tarball。一般会使用某种压缩算法压缩 tarball，压缩后的"><meta name=keywords content="tar,Linux"><meta itemprop=name content="什么是 tar"><meta itemprop=description content="tar 是 tape archive 的简称，即“磁带归档”，最早出现在 1979 年的第 UNIX v7。磁带上的数据存储为可能不相邻的变长数据块，浪费了大量块与块之间的空间。向磁盘、网络传输数据时，传输一大块的效率远高于多个小块，因此程序员使用 tar 将磁带上的数据打包在一起，物理上存储在连续的、固定大小的块上以提高性能。 tar 打包出来的文件称为为 tarball。一般会使用某种压缩算法压缩 tarball，压缩后的"><meta itemprop=datePublished content="2022-09-21T17:42:25+08:00"><meta itemprop=dateModified content="2022-09-21T17:42:25+08:00"><meta itemprop=wordCount content="5732"><meta itemprop=image content="/posts/2022/09/21/images/featured-image.webp"><meta itemprop=keywords content="Linux,"><meta property="og:title" content="什么是 tar"><meta property="og:description" content="tar 是 tape archive 的简称，即“磁带归档”，最早出现在 1979 年的第 UNIX v7。磁带上的数据存储为可能不相邻的变长数据块，浪费了大量块与块之间的空间。向磁盘、网络传输数据时，传输一大块的效率远高于多个小块，因此程序员使用 tar 将磁带上的数据打包在一起，物理上存储在连续的、固定大小的块上以提高性能。 tar 打包出来的文件称为为 tarball。一般会使用某种压缩算法压缩 tarball，压缩后的"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2022/09/21/"><meta property="og:image" content="/posts/2022/09/21/images/featured-image.webp"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-09-21T17:42:25+08:00"><meta property="article:modified_time" content="2022-09-21T17:42:25+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/2022/09/21/images/featured-image.webp"><meta name=twitter:title content="什么是 tar"><meta name=twitter:description content="tar 是 tape archive 的简称，即“磁带归档”，最早出现在 1979 年的第 UNIX v7。磁带上的数据存储为可能不相邻的变长数据块，浪费了大量块与块之间的空间。向磁盘、网络传输数据时，传输一大块的效率远高于多个小块，因此程序员使用 tar 将磁带上的数据打包在一起，物理上存储在连续的、固定大小的块上以提高性能。 tar 打包出来的文件称为为 tarball。一般会使用某种压缩算法压缩 tarball，压缩后的"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=/posts/2022/09/21/><link rel=prev href=/posts/2022/01/02/><link rel=next href=/posts/2022/09/27/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"什么是 tar","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/2022\/09\/21\/"},"image":[{"@type":"ImageObject","url":"\/posts\/2022\/09\/21\/images\/featured-image.webp","width":1814,"height":469}],"genre":"posts","keywords":"Linux","wordcount":5732,"url":"\/posts\/2022\/09\/21\/","datePublished":"2022-09-21T17:42:25+08:00","dateModified":"2022-09-21T17:42:25+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"孔俊"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title=孔俊的知识库><img loading=lazy src=/logo.svg srcset="/logo.svg, /logo.svg 1.5x, /logo.svg 2x" sizes=auto data-title=孔俊的知识库 data-alt=孔俊的知识库 class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>孔俊的知识库</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/archives/>归档</a></li><li class=menu-item><a class=menu-link href=/about/>关于我</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=孔俊的知识库><img loading=lazy src=/logo.svg srcset="/logo.svg, /logo.svg 1.5x, /logo.svg 2x" sizes=auto data-title=/logo.svg data-alt=/logo.svg class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>孔俊的知识库</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/archives/>归档</a></li><li class=menu-item><a class=menu-link href=/about/>关于我</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span title=转载 class=icon-repost><i class="fa-solid fa-share fa-fw" aria-hidden=true></i></span><span>什么是 tar</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
孔俊</span></span>
<span class=post-category>收录于 <a href=/categories/linux/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Linux</a></span></div><div class=post-meta-line><span title="发布于 2022-09-21 17:42:25"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2022-09-21>2022-09-21</time></span>&nbsp;<span title="更新于 2022-09-21 17:42:25"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2022-09-21>2022-09-21</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 5732 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 12 分钟</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/posts/2022/09/21/images/featured-image.webp srcset="/posts/2022/09/21/images/featured-image.webp, /posts/2022/09/21/images/featured-image.webp 1.5x, /posts/2022/09/21/images/featured-image.webp 2x" sizes=auto data-title=/posts/2022/09/21/images/featured-image.webp data-alt=/posts/2022/09/21/images/featured-image.webp style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#场景>场景</a></li><li><a href=#格式>格式</a><ul><li><a href=#v7>v7</a></li><li><a href=#ustar>UStar</a></li><li><a href=#pax>pax</a></li><li><a href=#old-gnu>Old GNU</a></li><li><a href=#gnu>GNU</a></li><li><a href=#对比>对比</a></li></ul></li><li><a href=#问题>问题</a><ul><li><a href=#tar-炸弹>tar 炸弹</a></li><li><a href=#顺序访问>顺序访问</a></li><li><a href=#错误检验>错误检验</a></li><li><a href=#竞争条件>竞争条件</a></li></ul></li><li><a href=#实现>实现</a><ul><li><a href=#go-语言>Go 语言</a></li><li><a href=#gnu-tar>GNU tar</a></li></ul></li><li><a href=#思考>思考</a></li><li><a href=#参考>参考</a></li></ul></nav></div></div><div class=content id=content><p>tar 是 <em>tape archive</em> 的简称，即“磁带归档”，最早出现在 1979 年的第 UNIX v7。磁带上的数据存储为可能不相邻的变长数据块，浪费了大量块与块之间的空间。向磁盘、网络传输数据时，传输一大块的效率远高于多个小块，因此程序员使用 tar 将磁带上的数据打包在一起，物理上存储在连续的、固定大小的块上以提高性能。</p><p>tar 打包出来的文件称为为 tarball。一般会使用某种压缩算法压缩 tarball，压缩后的 tarball 后缀一般为<code>tar.&lt;compress-algorithm></code>，比如 gzip 压缩的 tarball 名为<code>tar.gz</code>，zstd 压缩的 tarball 名为<code>tar.zstd</code>。</p><h2 id=场景>场景</h2><p>tar 被广泛使用，一个经典的场景是数据备份，将一个目录打包成 tarball 拷贝到别的机器并恢复。</p><p>tar 不仅被用于上述运维/系统管理领域，在容器中也有应用。容器镜像是分层存储的，其中每一层都是一个 tarball（可能被压缩）。</p><h2 id=格式>格式</h2><p>最早的格式是 UNIX v7 格式，即 UNIX V7 中 tar 所使用的格式，，后来的各种 tar 格式都基于此格式拓展。</p><p>目前广泛使用的格式有 UStar、pax 和 GNU，其中 UStar 和 pax 是 POSIX 标准，GNU 格式未标准化但被广泛使用。</p><p>tarball 包含一系列文件对象，文件对象在物理上存储为一个或多个<em>块(block)</em>，tarball 末尾由两个连续的内容为零（<code>\0</code>）的块标示。文件对象是一个 header 和 data 的组合、类似于 TCP 报文段。</p><p>最初的 UNIX V7 tar 不要求块末尾的*填充（padding）*为零，但现代实现一般都把填充内容设置为空字符<code>\0</code>。</p><p>大体上 tar 的格式是这样的，pax/gnu 等格式在此基础上有一些拓展，比如 pax 格式中将 <em>extend header data</em> 也存放在文件对象的 data 部分，所以 data 部分可能不仅仅是原始的文件数据。</p><h3 id=v7>v7</h3><p>v7 格式 header 如下：</p><table><thead><tr><th>Field offset</th><th>Field size</th><th>Field</th></tr></thead><tbody><tr><td>0</td><td>100</td><td>File name</td></tr><tr><td>100</td><td>8</td><td>File mode (octal)</td></tr><tr><td>108</td><td>8</td><td>Owner&rsquo;s numeric user ID (octal)</td></tr><tr><td>116</td><td>8</td><td>Group&rsquo;s numeric user ID (octal)</td></tr><tr><td>124</td><td>12</td><td>File size in bytes (octal)</td></tr><tr><td>136</td><td>12</td><td>Last modification time in numeric Unix time format (octal)</td></tr><tr><td>148</td><td>8</td><td>Checksum for header record</td></tr><tr><td>156</td><td>1</td><td>Link indicator (file type)</td></tr><tr><td>157</td><td>100</td><td>Name of linked file</td></tr></tbody></table><p>link indicator 字段可以取以下值:</p><table><thead><tr><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td>&lsquo;0&rsquo; or (ASCII NUL)</td><td>Normal file</td></tr><tr><td>&lsquo;1&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Hard_link title="Hard link" target=_blank rel="external nofollow noopener noreferrer">Hard link<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;2&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Symbolic_link title="Symbolic link" target=_blank rel="external nofollow noopener noreferrer">Symbolic link<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr></tbody></table><p>tarball 被设计为一个文本文件，header 的各字段都是 ASCII 编码的。因此，对于一个原始文件都是文本的 tarball，那么它自身也一定是一个文本文件。</p><p>文件大小使用 ASCII 编码的八进制表示，并且字段最后一个字节为空，实际上只有 11 个字节用于编码，所以 v7 格式单个文件大小最大为 8GB（077777777 字节）。可见 v7 格式非常简单，不包含 xattr、group name、user name、MIME 类型、文件编码等关键信息，并且文件名长度也限制在 99 字节（不算末尾的<code>\0</code>）。</p><p>tar 对硬链接的处理有专门的规定，即<strong>将硬链接指向的文件写入到 tarball 中，其他硬链接作为 hard link 写入 tarball</strong>。GNU tar <code>--hard-dereference</code>将所有硬链接当成独立的内容相同的文件处理。</p><blockquote><p>If hard links exist, the target is the first occurrence of the
hard link that is saved in the archive. Subsequent hard links refer to the first instance.</p></blockquote><p>这个示例展示 tar 如何处理符号链接和硬链接。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;TEST&#34;</span> &gt; <span class=nb>test</span>
</span></span><span class=line><span class=cl>$ <span class=k>for</span> i in <span class=k>$(</span>seq <span class=m>1</span> 3<span class=k>)</span><span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=cl>ln /tmp/test /tmp/test.link<span class=si>${</span><span class=nv>i</span><span class=si>}</span>
</span></span><span class=line><span class=cl><span class=k>done</span>
</span></span><span class=line><span class=cl>$ ls -li test*
</span></span><span class=line><span class=cl><span class=m>18451488</span> -rw-r--r-- <span class=m>4</span> kongjun kongjun <span class=m>5</span>  9月 <span class=m>21</span> 10:22 <span class=nb>test</span>
</span></span><span class=line><span class=cl><span class=m>18451488</span> -rw-r--r-- <span class=m>4</span> kongjun kongjun <span class=m>5</span>  9月 <span class=m>21</span> 10:22 test.link1
</span></span><span class=line><span class=cl><span class=m>18451488</span> -rw-r--r-- <span class=m>4</span> kongjun kongjun <span class=m>5</span>  9月 <span class=m>21</span> 10:22 test.link2
</span></span><span class=line><span class=cl><span class=m>18451488</span> -rw-r--r-- <span class=m>4</span> kongjun kongjun <span class=m>5</span>  9月 <span class=m>21</span> 10:22 test.link3
</span></span><span class=line><span class=cl>$ tar -cv -f hardlink.tar test*
</span></span><span class=line><span class=cl><span class=nb>test</span>
</span></span><span class=line><span class=cl>test.link1
</span></span><span class=line><span class=cl>test.link2
</span></span><span class=line><span class=cl>test.link3
</span></span><span class=line><span class=cl> 只写入一次文件
</span></span><span class=line><span class=cl>$ tar -tv -f hardlink.tar
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-21 10:22 <span class=nb>test</span>
</span></span><span class=line><span class=cl>hrw-r--r-- kongjun/kongjun   <span class=m>0</span> 2022-09-21 10:22 test.link1 连接到 <span class=nb>test</span>
</span></span><span class=line><span class=cl>hrw-r--r-- kongjun/kongjun   <span class=m>0</span> 2022-09-21 10:22 test.link2 连接到 <span class=nb>test</span>
</span></span><span class=line><span class=cl>hrw-r--r-- kongjun/kongjun   <span class=m>0</span> 2022-09-21 10:22 test.link3 连接到 <span class=nb>test</span>
</span></span><span class=line><span class=cl>$ tar -cv --hard-dereference -f hardlink.tar test*
</span></span><span class=line><span class=cl><span class=nb>test</span>
</span></span><span class=line><span class=cl>test.link1
</span></span><span class=line><span class=cl>test.link2
</span></span><span class=line><span class=cl>test.link3
</span></span><span class=line><span class=cl> 所有硬链接当成内容完全相同的文件处理
</span></span><span class=line><span class=cl>$ tar -tv -f hardlink.tar
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-21 10:22 <span class=nb>test</span>
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-21 10:22 test.link1
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-21 10:22 test.link2
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-21 10:22 test.link3
</span></span></code></pre></div><h3 id=ustar>UStar</h3><p>UStar(Unix Standard TAR) 是 POSIX 标准化（POSIX.1-1988 and POSIX.1-2001）的格式，GNU tar 文档称为基础 tar 格式（<em>basic tar format</em>），通常现代 tar 都支持此格式。</p><p>UStar 在 v7 的基础上，拓展了 header，支持更多文件类型，添加了所有者名字，增大了文件名最大长度。</p><table><thead><tr><th>Field offset</th><th>Field size</th><th>Field</th></tr></thead><tbody><tr><td>0</td><td>156</td><td><em>(Several fields, same as in the old format)</em></td></tr><tr><td>156</td><td>1</td><td>Type flag</td></tr><tr><td>157</td><td>100</td><td><em>(Same field as in the old format)</em></td></tr><tr><td>257</td><td>6</td><td>UStar indicator &ldquo;ustar&rdquo; then NUL</td></tr><tr><td>263</td><td>2</td><td>UStar version &ldquo;00&rdquo;</td></tr><tr><td>265</td><td>32</td><td>Owner user name</td></tr><tr><td>297</td><td>32</td><td>Owner group name</td></tr><tr><td>329</td><td>8</td><td>Device major number</td></tr><tr><td>337</td><td>8</td><td>Device minor number</td></tr><tr><td>345</td><td>155</td><td>Filename prefix</td></tr></tbody></table><p>v7 中的 link indicator 在 UStar 中拓展为 type flag，可以取以下值：</p><table><thead><tr><th>Value</th><th>Meaning</th></tr></thead><tbody><tr><td>&lsquo;0&rsquo; or (<a href=https://en.wikipedia.org/wiki/ASCII title=ASCII target=_blank rel="external nofollow noopener noreferrer">ASCII<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> <a href=https://en.wikipedia.org/wiki/Null_character title="Null character" target=_blank rel="external nofollow noopener noreferrer">NUL<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>)</td><td>Normal file</td></tr><tr><td>&lsquo;1&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Hard_link title="Hard link" target=_blank rel="external nofollow noopener noreferrer">Hard link<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;2&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Symbolic_link title="Symbolic link" target=_blank rel="external nofollow noopener noreferrer">Symbolic link<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;3&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Device_file title="Device file" target=_blank rel="external nofollow noopener noreferrer">Character special<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;4&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Device_file title="Device file" target=_blank rel="external nofollow noopener noreferrer">Block special<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;5&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Directory_%28computing%29 title="Directory (computing)" target=_blank rel="external nofollow noopener noreferrer">Directory<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;6&rsquo;</td><td><a href=https://en.wikipedia.org/wiki/Named_pipe title="Named pipe" target=_blank rel="external nofollow noopener noreferrer">FIFO<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></td></tr><tr><td>&lsquo;7&rsquo;</td><td>Contiguous file</td></tr><tr><td>&lsquo;g&rsquo;</td><td>Global extended header with meta data (POSIX.1-2001)</td></tr><tr><td>&lsquo;x&rsquo;</td><td>Extended header with meta data for the next file in the archive (POSIX.1-2001)</td></tr><tr><td>&lsquo;A&rsquo;–&lsquo;Z&rsquo;</td><td>Vendor specific extensions (POSIX.1-1988)</td></tr><tr><td>All other values</td><td>Reserved for future standardization</td></tr></tbody></table><p>其中 continuous file 指此文件在存储在磁盘连续的块中，OS 一般不提供这样的接口，因此几乎所有 tar 实现都把忽略此类型，当成一般的文件处理。</p><p>x 和 g 类型用于 pax 格式，这样的 header 称为 pax header block，其数据是 pax extended header。</p><h3 id=pax>pax</h3><p>前面的 v7、UStar 格式都有很多限制，比如文件名长度有限，无法记录 ACL 信息，无法记录文件 MIME 类型等信息。这些问题可以通过打标签统一解决，比如 ACL 在文件系统层面就是 xattr 而已，在 tar 中自然也可通过打相应标签解决。</p><p>pax(<em>portable archive interchange</em>) 格式最早由 Sun Microsystems 发明，由 POSIX.1-2001 标准化，GNU tar 文档称指为 POSIX 格式。</p><p>pax 被设计为，凡是支持 UStar 的 tar 实现，都可以处理 pax 格式。具体地说，pax 没有带来任何不兼容的新字段，只是为 UStar header/data 添加了新的语义。pax 分为 pax header block 和 pax extended header 两部分，pax header 是 type flag为 x 或 g 的 UStar header，pax extended header 是拓展的元数据，作为 Ustar 数据存储。</p><p>pax 格式 tarball 布局如下：</p><table><thead><tr><th>Header block</th><th>File</th></tr></thead><tbody><tr><td>UStar Header [<code>typeflag=g</code>]</td><td>Global Extended Header.</td></tr><tr><td>Global Extended Header Data</td><td>Global Extended Header.</td></tr><tr><td>UStar Header [<code>typeflag=x</code>]</td><td>File 1: Extended Header is included.</td></tr><tr><td>Extended Header Data</td><td>File 1: Extended Header is included.</td></tr><tr><td>UStar Header [<code>typeflag=0</code>]</td><td>File 1: Extended Header is included.</td></tr><tr><td>Data for File 1</td><td>File 1: Extended Header is included.</td></tr><tr><td>UStar Header [<code>typeflag=0</code>]</td><td>File 2: No Extended Header is included.</td></tr><tr><td>Data for File 2</td><td>File 2: No Extended Header is included.</td></tr><tr><td>Block of binary zeros</td><td>End of Archive Indicator.</td></tr></tbody></table><p>可见，pax 格式的 tarball 完全可以当成 UStar 格式处理，只是会数去 pax 格式添加的许多信息而已。为了让只支持 UStar 格式的 tar 也能正常处理 pax 格式，pax 建议实现</p><ol><li><p>设置合法的文件名以便只支持 UStar 格式的 tar 能正确创建文件。</p></li><li><p>文件名长度不不要超过 99 字节，否则无法被只支持 UStar 格式的 tar 正确处理。</p></li></ol><p>pax header block 目前只有两种类型：</p><ul><li><p>x：表示该拓展头只作用于 tarball 中的下一个文件。</p></li><li><p>g：表示该拓展头是全局的，作用于 tarball 中所有再其后面的文件。</p></li></ul><p>pax extended header 是拓展的头，即拓展的元数据（标签），格式为<code>"%d %s=%s\n", &lt;length>, &lt;keyword>, &lt;value></code>。其中<code>length</code>是包括末尾的换行符的八进制编码的长度（和 v7/UStar 保存一致），<code>keyword</code>和<code>value</code>必须使用<a href=https://pubs.opengroup.org/onlinepubs/9699919799/basedefs/V1_chap03.html#tag_03_282 target=_blank rel="external nofollow noopener noreferrer">Portable Filename Character Set<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>中的字符。extended header 的字符编码为 UTF-8。</p><p>类型为 x 的 extended header 可以覆盖全局 extended header 中的<code>keyword</code>。<code>keyword</code>值为空时，删除该<code>keyword</code>；<code>keyword</code>值不为空时，增加或覆盖该<code>keyword</code>。extended header 中的字段即可以</p><ul><li><p>记录额外元数据。比如 atime 等信息。</p></li><li><p>调整 UStar header option 的行为。比如 hdrcharset 可以修改 UStar header 中的文件名字符编码。</p></li><li><p>覆盖 UStar header option。比如 size 可以覆盖 UStar header 中记录的大小以支持大于 8G 的文件。</p></li></ul><p>类似于 <a href=https://www.man7.org/linux/man-pages/man7/xattr.7.html target=_blank rel="external nofollow noopener noreferrer">xattr(7)<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>，pax extended header 中可使用的字段是预定义的。POSIX 标准规定的字段如下：</p><blockquote><p><strong>atime</strong></p><p>The file access time for the following file(s), equivalent to the value of the <em>st_atime</em> member of the <strong>stat</strong> structure for a file, as described by the <a href=https://pubs.opengroup.org/onlinepubs/9699919799/functions/stat.html target=_blank rel="external nofollow noopener noreferrer"><em>stat</em>()<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> function. The access time shall be restored if the process has appropriate privileges required to do so. The format of the &lt;<em>value</em>> shall be as described
in <a href=https://pubs.opengroup.org/onlinepubs/9699919799/utilities/pax.html#tag_20_92_13_05 target=_blank rel="external nofollow noopener noreferrer">pax Extended Header File Times<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>.</p><p><strong>charset</strong></p><p>The name of the character set used to encode the data in the following file(s). The entries in the following table are defined to refer to known standards; additional names may be agreed on between the originator and recipient.</p><table><thead><tr><th><strong><value></strong></th><th><strong>Formal Standard</strong></th></tr></thead><tbody><tr><td>ISO-IRΔ646Δ1990</td><td>ISO/IEC 646:1990</td></tr><tr><td>ISO-IRΔ8859Δ1Δ1998</td><td>ISO/IEC 8859-1:1998</td></tr><tr><td>ISO-IRΔ8859Δ2Δ1999</td><td>ISO/IEC 8859-2:1999</td></tr><tr><td>ISO-IRΔ8859Δ3Δ1999</td><td>ISO/IEC 8859-3:1999</td></tr><tr><td>ISO-IRΔ8859Δ4Δ1998</td><td>ISO/IEC 8859-4:1998</td></tr><tr><td>ISO-IRΔ8859Δ5Δ1999</td><td>ISO/IEC 8859-5:1999</td></tr><tr><td>ISO-IRΔ8859Δ6Δ1999</td><td>ISO/IEC 8859-6:1999</td></tr><tr><td>ISO-IRΔ8859Δ7Δ1987</td><td>ISO/IEC 8859-7:1987</td></tr><tr><td>ISO-IRΔ8859Δ8Δ1999</td><td>ISO/IEC 8859-8:1999</td></tr><tr><td>ISO-IRΔ8859Δ9Δ1999</td><td>ISO/IEC 8859-9:1999</td></tr><tr><td>ISO-IRΔ8859Δ10Δ1998</td><td>ISO/IEC 8859-10:1998</td></tr><tr><td>ISO-IRΔ8859Δ13Δ1998</td><td>ISO/IEC 8859-13:1998</td></tr><tr><td>ISO-IRΔ8859Δ14Δ1998</td><td>ISO/IEC 8859-14:1998</td></tr><tr><td>ISO-IRΔ8859Δ15Δ1999</td><td>ISO/IEC 8859-15:1999</td></tr><tr><td>ISO-IRΔ10646Δ2000</td><td>ISO/IEC 10646:2000</td></tr><tr><td>ISO-IRΔ10646Δ2000ΔUTF-8</td><td>ISO/IEC 10646, UTF-8 encoding</td></tr><tr><td>BINARY</td><td>None.</td></tr></tbody></table><p>The encoding is included in an extended header for information only; when <em>pax</em> is used as described in POSIX.1-2017, it shall not translate the file data into any other encoding. The <strong>BINARY</strong> entry indicates unencoded binary data.</p><p>When used in <strong>write</strong> or <strong>copy</strong> mode, it is implementation-defined whether <em>pax</em> includes a <strong>charset</strong> extended header record for a file.</p><p><strong>comment</strong></p><p>A series of characters used as a comment. All characters in the &lt;<em>value</em>> field shall be ignored by <em>pax</em>.</p><p><strong>gid</strong></p><p>The group ID of the group that owns the file, expressed as a decimal number using digits from the ISO/IEC 646:1991 standard. This record shall override the <em>gid</em> field in the following header block(s). When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <em>gid</em> extended header record for each file whose group ID is greater than 2097151(octal 7777777).</p><p><strong>gname</strong></p><p>The group of the file(s), formatted as a group name in the group database. This record shall override the <em>gid</em> and <em>gname</em> fields in the following header block(s), and any <em>gid</em> extended header record. When used in <strong>read</strong>, <strong>copy</strong>, or <strong>list</strong> mode, <em>pax</em> shall translate the name from the encoding in the header record to the character set appropriate for the group database on the receiving system. If any of the characters cannot be translated, and if neither the <strong>-o</strong> <strong>invalid=UTF-8</strong> option nor the <strong>-o</strong> <strong>invalid=binary</strong> option is specified, the results are
implementation-defined. When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <strong>gname</strong> extended header record for each file whose group name cannot be represented entirely with the letters and digits of the portable character
set.</p><p><strong>hdrcharset</strong></p><p>The name of the character set used to encode the value field of the <strong>gname</strong>, <strong>linkpath</strong>, <strong>path</strong>, and <strong>uname</strong> <em>pax</em> extended header records. The entries in the following table are defined to refer to known standards;
additional names may be agreed between the originator and the recipient.</p><table><thead><tr><th><strong><value></strong></th><th><strong>Formal Standard</strong></th></tr></thead><tbody><tr><td>ISO-IRΔ10646Δ2000ΔUTF-8</td><td>ISO/IEC 10646, UTF-8 encoding</td></tr><tr><td>BINARY</td><td>None.</td></tr></tbody></table><p>If no <strong>hdrcharset</strong> extended header record is specified, the default character set used to encode all values in extended header records shall be the ISO/IEC 10646-1:2000 standard UTF-8 encoding.</p><p>The <strong>BINARY</strong> entry indicates that all values recorded in extended headers for affected files are unencoded binary data from
the underlying system.</p><p><strong>linkpath</strong></p><p>The pathname of a link being created to another file, of any type, previously archived. This record shall override the <em>linkname</em> field in the following <strong>ustar</strong> header block(s). The following <strong>ustar</strong> header block shall determine the
type of link created. If <em>typeflag</em> of the following header block is 1, it shall be a hard link. If <em>typeflag</em> is 2, it shall be a symbolic link and the <strong>linkpath</strong> value shall be the contents of the symbolic link. The <em>pax</em> utility shall
translate the name of the link (contents of the symbolic link) from the
encoding in the header to the character set appropriate for
the local file system. When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <strong>linkpath</strong> extended header record for each link whose pathname cannot be represented entirely with the members of the portable character set other than NUL.</p><p><strong>mtime</strong></p><p>The file modification time of the following file(s), equivalent to the value of the <em>st_mtime</em> member of the <strong>stat</strong> structure for a file, as described in the <a href=https://pubs.opengroup.org/onlinepubs/9699919799/functions/stat.html target=_blank rel="external nofollow noopener noreferrer"><em>stat</em>()<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> function. This record shall override the <em>mtime</em> field in the following header block(s). The modification time shall be restored if the process has appropriate
privileges required to do so. The format of the &lt;<em>value</em>> shall be as described in <a href=https://pubs.opengroup.org/onlinepubs/9699919799/utilities/pax.html#tag_20_92_13_05 target=_blank rel="external nofollow noopener noreferrer">pax Extended Header File Times<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>.</p><p><strong>path</strong></p><p>The pathname of the following file(s). This record shall override the <em>name</em> and <em>prefix</em> fields in the following header block(s). The <em>pax</em> utility shall translate the pathname of the file from the encoding in the header to the character set appropriate for the local file system.</p><p>When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <em>path</em> extended header record for each file whose pathname cannot be represented entirely with the members of the portable character set other than NUL.</p><p><strong>realtime</strong>.any</p><p>The keywords prefixed by &ldquo;realtime.&rdquo; are reserved for future standardization.</p><p><strong>security</strong>.any</p><p>The keywords prefixed by &ldquo;security.&rdquo; are reserved for future standardization.</p><p><strong>size</strong></p><p>The size of the file in octets, expressed as a decimal number using digits from the ISO/IEC 646:1991 standard. This record shall override the <em>size</em> field in the following header block(s). When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <em>size</em> extended header record for each file with a size value greater than 8589934591 (octal 77777777777).</p><p><strong>uid</strong></p><p>The user ID of the file owner, expressed as a decimal number using digits from the ISO/IEC 646:1991 standard. This record shall override the <em>uid</em> field in the following header block(s). When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <em>uid</em> extended header record for each file whose owner ID is greater than 2097151 (octal 7777777).</p><p><strong>uname</strong></p><p>The owner of the following file(s), formatted as a user name in the user database. This record shall override the <em>uid</em> and <em>uname</em> fields in the following header block(s), and any <em>uid</em> extended header record. When used in <strong>read</strong>, <strong>copy</strong>, or <strong>list</strong> mode, <em>pax</em> shall translate the name from the encoding in the header record to the character set appropriate for the user database on the receiving system. If any of the characters cannot be translated, and if neither the <strong>-o</strong> <strong>invalid=UTF-8</strong> option nor the <strong>-o</strong> <strong>invalid=binary</strong> option is specified, the results are implementation-defined. When used in <strong>write</strong> or <strong>copy</strong> mode, <em>pax</em> shall include a <strong>uname</strong> extended header record for each file whose user name cannot be represented entirely with the letters and digits of the portable character set.</p></blockquote><h3 id=old-gnu>Old GNU</h3><p>Old GNU 格式指 GNU tar 在 1990 年于 v1.09 引入的格式，该格式建立在 POSIX.1-1988 UStar 格式上，覆盖了一些 POSIX 要求的字段，造成兼容问题。因此，此格式已被弃用，GNU tar 文档中甚至没有详细介绍。</p><h3 id=gnu>GNU</h3><p>GNU 格式早于 pax 格式，基于早期 UStar 格式，解决了 UStar 格式不支持超过 8G 的大文件、长度超过 100 个字符的文件名等缺陷。</p><p>pax 格式标准化后，GNU 格式不再有存在的意义，GNU tar 文档声明将来会将默认格式迁移到 pax。</p><h3 id=对比>对比</h3><table><thead><tr><th>Attribute</th><th>USTAR</th><th>PAX</th><th>GNU</th></tr></thead><tbody><tr><td>Name</td><td>256B</td><td>unlimited</td><td>unlimited</td></tr><tr><td>Linkname</td><td>100B</td><td>unlimited</td><td>unlimited</td></tr><tr><td>Size</td><td>uint33</td><td>unlimited</td><td>uint89</td></tr><tr><td>Mode</td><td>uint21</td><td>uint21</td><td>uint57</td></tr><tr><td>Uid/Gid</td><td>uint21</td><td>unlimited</td><td>uint57</td></tr><tr><td>Uname/Gname</td><td>32B</td><td>unlimited</td><td>32B</td></tr><tr><td>ModTime</td><td>uint33</td><td>unlimited</td><td>int89</td></tr><tr><td>AccessTime</td><td>n/a</td><td>unlimited</td><td>int89</td></tr><tr><td>ChangeTime</td><td>n/a</td><td>unlimited</td><td>int89</td></tr><tr><td>Devmajor/Devminor</td><td>uint21</td><td>uint21</td><td>uint57</td></tr><tr><td>string encoding</td><td>ASCII</td><td>UTF-8</td><td>binary</td></tr><tr><td>sub-second times</td><td>no</td><td>yes</td><td>no</td></tr><tr><td>sparse files</td><td>no</td><td>yes</td><td>yes</td></tr></tbody></table><h2 id=问题>问题</h2><h3 id=tar-炸弹>tar 炸弹</h3><ul><li><p>tarball 绝对路径或父级路径，解压后覆盖同名文件。</p></li><li><p>创建 tarball 前，攻击者创建指向敏感文件（如 /etc/passwd）的符号链接，创建 tarball 默认跟随符号链接，导致敏感文件被错误归档。</p></li><li><p>创建 tarball 时，攻击者将文件/目录修改为符号链接，比如<code>tar /home/usera</code>，攻击者将 /home/usera 设置为指向 /home/userb 的符号链接，导致 userb 目录被错误归档。</p></li><li><p>使用两个同名路径，第一个是符号链接，第二个是常规文件，解压后覆盖了符号链接指向的文件。</p></li></ul><h3 id=顺序访问>顺序访问</h3><p>tar 最初是做磁带归档的软件，磁带不支持顺序访问，tar 自然也不支持。<code>tar</code>命令的<code>-u(--update)</code>并不是覆盖 tarball 中的文件，而是找到 tarball 的同名文件，比较最近修改时间，将更新的版本附加到末尾，解压后最后的文件是最终提取出来的版本。</p><p>下面的命令更新 connection.tar 中的文件 blues、fork、rock 和 classical，其中 blues 和 classical 两文件更新，附加到末尾。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;classical&#34;</span> &gt; classical
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;rock&#34;</span> &gt; rock
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;folk&#34;</span> &gt; folk
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;blues&#34;</span> &gt; blues
</span></span><span class=line><span class=cl>$ tar -cv -f collection.tar blues folk rock classical
</span></span><span class=line><span class=cl>blues
</span></span><span class=line><span class=cl>folk
</span></span><span class=line><span class=cl>rock
</span></span><span class=line><span class=cl>classical
</span></span><span class=line><span class=cl>$ tar -tv -f collection.tar
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>6</span> 2022-09-20 15:30 blues
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-20 15:30 folk
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-20 15:29 rock
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun  <span class=m>10</span> 2022-09-20 15:29 classical
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;bluesblues&#34;</span> &gt; blues
</span></span><span class=line><span class=cl>$ <span class=nb>echo</span> <span class=s2>&#34;classicalclassical&#34;</span> &gt; classical
</span></span><span class=line><span class=cl>$ tar --update -v -f collection.tar blues folk rock classical
</span></span><span class=line><span class=cl>blues
</span></span><span class=line><span class=cl>classical
</span></span><span class=line><span class=cl>$ tar -tv -f collection.tar
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>6</span> 2022-09-20 15:30 blues
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-20 15:30 folk
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun   <span class=m>5</span> 2022-09-20 15:29 rock
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun  <span class=m>10</span> 2022-09-20 15:29 classical
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun  <span class=m>11</span> 2022-09-20 15:30 blues
</span></span><span class=line><span class=cl>-rw-r--r-- kongjun/kongjun  <span class=m>19</span> 2022-09-20 15:30 classical
</span></span></code></pre></div><h3 id=错误检验>错误检验</h3><p>tar 没有完善的错误校验机制。如果在传输过程中出错，难以依靠 header 中简单的 checksum 进行错误检测与恢复。</p><p>如果要验证数据完整性，可以在网络传输之前先使用 cksum 之类的命令计算 checksum，接受到 tarball 后比较。</p><p>恢复出错的数据几乎是不可能的，用户只能在了解 tar 格式的前提下，跳过错误的文件。</p><h3 id=竞争条件>竞争条件</h3><p>tar 只是将文件系统中的文件归档起来，不做任何高级的多余操作。归档过程中的文件修改、增删可能导致归档文件和原始数据不一致，甚至导致归档失败。</p><p>因此，必须确保归档过程中没有进程访问文件系统。备份系统中常用的办法是创建文件系统快照，然后归档此快照。</p><h2 id=实现>实现</h2><h3 id=go-语言>Go 语言</h3><p>Go 语言标准库包 archive/tar 实现了 tar，支持 ustar、pax 和 GNU 格式。Go 语言实现屏蔽了部分底层格式的差异，让用户聚焦于关键的 tar 属性。查看<code>Header</code>定义就可以发现这一点，定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-Go data-lang=Go><span class=line><span class=cl><span class=kd>type</span> <span class=nx>Header</span> <span class=kd>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>	<span class=c1>// Typeflag is the type of header entry.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The zero value is automatically promoted to either TypeReg or TypeDir
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// depending on the presence of a trailing slash in Name.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Typeflag</span> <span class=kt>byte</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=nx>Name</span>     <span class=kt>string</span> <span class=c1>// Name of file entry
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Linkname</span> <span class=kt>string</span> <span class=c1>// Target name of link (valid for TypeLink or TypeSymlink)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>Size</span>  <span class=kt>int64</span>  <span class=c1>// Logical file size in bytes
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Mode</span>  <span class=kt>int64</span>  <span class=c1>// Permission and mode bits
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Uid</span>   <span class=kt>int</span>    <span class=c1>// User ID of owner
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Gid</span>   <span class=kt>int</span>    <span class=c1>// Group ID of owner
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Uname</span> <span class=kt>string</span> <span class=c1>// User name of owner
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Gname</span> <span class=kt>string</span> <span class=c1>// Group name of owner
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// If the Format is unspecified, then Writer.WriteHeader rounds ModTime
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// to the nearest second and ignores the AccessTime and ChangeTime fields.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// To use AccessTime or ChangeTime, specify the Format as PAX or GNU.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// To use sub-second resolution, specify the Format as PAX.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ModTime</span>    <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=c1>// Modification time
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>AccessTime</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=c1>// Access time (requires either PAX or GNU support)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>ChangeTime</span> <span class=nx>time</span><span class=p>.</span><span class=nx>Time</span> <span class=c1>// Change time (requires either PAX or GNU support)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=nx>Devmajor</span> <span class=kt>int64</span> <span class=c1>// Major device number (valid for TypeChar or TypeBlock)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Devminor</span> <span class=kt>int64</span> <span class=c1>// Minor device number (valid for TypeChar or TypeBlock)
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>	<span class=c1>// Xattrs stores extended attributes as PAX records under the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// &#34;SCHILY.xattr.&#34; namespace.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The following are semantically equivalent:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//  h.Xattrs[key] = value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//  h.PAXRecords[&#34;SCHILY.xattr.&#34;+key] = value
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// When Writer.WriteHeader is called, the contents of Xattrs will take
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// precedence over those in PAXRecords.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Deprecated: Use PAXRecords instead.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Xattrs</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// PAXRecords is a map of PAX extended header records.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// User-defined records should have keys of the following form:
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//	VENDOR.keyword
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Where VENDOR is some namespace in all uppercase, and keyword may
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// not contain the &#39;=&#39; character (e.g., &#34;GOLANG.pkg.version&#34;).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// The key and value should be non-empty UTF-8 strings.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// When Writer.WriteHeader is called, PAX records derived from the
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// other fields in Header take precedence over PAXRecords.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>PAXRecords</span> <span class=kd>map</span><span class=p>[</span><span class=kt>string</span><span class=p>]</span><span class=kt>string</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>	<span class=c1>// Format specifies the format of the tar header.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// This is set by Reader.Next as a best-effort guess at the format.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// Since the Reader liberally reads some non-compliant files,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// it is possible for this to be FormatUnknown.
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>//
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// If the format is unspecified when Writer.WriteHeader is called,
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// then it uses the first format (in the order of USTAR, PAX, GNU)
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=c1>// capable of encoding this Header (see Format).
</span></span></span><span class=line><span class=cl><span class=c1></span>	<span class=nx>Format</span> <span class=nx>Format</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=gnu-tar>GNU tar</h3><p>GNU tar 是 GNU/Linux 上默认的 tar 实现，目前默认使用 GNU 格式，但文档声明将来会迁移到 pax 格式。</p><p>为了缓解安全问题，GNU tar 默认不解引用符号链接，创建归档时去除路径开头的 /。</p><h2 id=思考>思考</h2><ul><li><p>tar 只做好归档，它不完美，但足够好。40 年后的今天，仍然活跃于容器镜像中。</p></li><li><p>tar 格式从 v7 发展到 ustar，再到如今的 pax，展示了怎样在保持兼容的前提下拓展。</p></li><li><p>与其定死属性（attribute），不如考虑下打标签，打标签更易拓展。</p></li></ul><h2 id=参考>参考</h2><ul><li><a href=https://www.gnu.org/software/tar/manual/html_chapter/Formats.html target=_blank rel="external nofollow noopener noreferrer">GNU tar 1.34: 8 Controlling the Archive Format<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://www.gnu.org/software/tar/manual/html_node/how-to-update.html#how-to-update target=_blank rel="external nofollow noopener noreferrer">GNU tar 1.34: 4.2.3.1 How to Update an Archive Using &ndash;update<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://pubs.opengroup.org/onlinepubs/9699919799/utilities/pax.html target=_blank rel="external nofollow noopener noreferrer">pax - portable archive interchange<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href="https://www.ibm.com/docs/en/zos/2.3.0?topic=descriptions-pax-interchange-portable-archivesportable-archives" target=_blank rel="external nofollow noopener noreferrer">IBM Document z/OS/2.3.0/pax - Interchange portable archives<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href="https://www.ibm.com/docs/en/zos/2.3.0?topic=ff-pax-format-pax-archives-special-header-summary-files" target=_blank rel="external nofollow noopener noreferrer">IBM Documentation tar<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href="https://www.freebsd.org/cgi/man.cgi?query=tar" target=_blank rel="external nofollow noopener noreferrer">BSD tar<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://man7.org/linux/man-pages/man1/tar.1.html target=_blank rel="external nofollow noopener noreferrer">tar(1) - Linux manual page<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://unix.stackexchange.com/questions/43037/dereferencing-hard-links target=_blank rel="external nofollow noopener noreferrer">tar - Dereferencing hard links - Unix &Linux Stack Exchange<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://en.wikipedia.org/wiki/Tar_%28computing%29 target=_blank rel="external nofollow noopener noreferrer">tar (computing) - Wikipedia<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://www.gnu.org/software/tar/manual/html_node/Security.html#Security target=_blank rel="external nofollow noopener noreferrer">GNU tar 1.34: 10.2 Security<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://www.gnu.org/software/tar/manual/html_node/Reliability.html#Reliability target=_blank rel="external nofollow noopener noreferrer">GNU tar 1.34: 10.1 Reliability<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li><li><a href=https://pkg.go.dev/archive/tar@go1.19.1 target=_blank rel="external nofollow noopener noreferrer">tar package - archive/tar - Go Packages<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a></li></ul></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2022-09-21 17:42:25">更新于 2022-09-21&nbsp;</span></div><div class=post-info-license><span>All rights reserved</span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=/posts/2022/09/21/ data-title="什么是 tar" data-hashtags=Linux><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=/posts/2022/09/21/ data-hashtag=Linux><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=/posts/2022/09/21/ data-title="什么是 tar"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/linux/ class=post-tag>Linux</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/2022/01/02/ class=post-nav-item rel=prev title="Lua 语言简明教程"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>Lua 语言简明教程</a>
<a href=/posts/2022/09/27/ class=post-nav-item rel=next title="【译】拨开 Linux 平均负载的谜团">【译】拨开 Linux 平均负载的谜团<i class="fa-solid fa-angle-right fa-fw" aria-hidden=true></i></a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways data-mode=static><div><img loading=lazy src=/alipay.jpg srcset="/alipay.jpg, /alipay.jpg 1.5x, /alipay.jpg 2x" sizes=auto data-title="孔俊 支付宝" data-alt="孔俊 支付宝" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span>支付宝</span></div><div><img loading=lazy src=/wechatpay.png srcset="/wechatpay.png, /wechatpay.png 1.5x, /wechatpay.png 2x" sizes=auto data-title="孔俊 微信" data-alt="孔俊 微信" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span>微信</span></div></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kongjun18/kongjun18.github.io data-repo-id=R_kgDOICeqmQ data-category=Announcements data-category-id=DIC_kwDOICeqmc4CVeTb data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/kongjun18/blog title=查看博客源代码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:40},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},pangu:{enable:!0,selector:"article"}}</script><script src=/js/theme.min.js defer></script></body></html>
<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=2"><meta name=robots content="noodp"><title>致敬经典：K&R allocator 内存分配器 - 孔俊的知识库</title><meta name=author content><meta name=author-link content><meta name=description content="k&R allocator 是Brain Kernighan和 Dennis Ritchie 的名著 The C Programming Language 第 8.7 节中介绍的一个简单 malloc 实现。因为该书被称为 K&R C，这个 malloc 实现也被称为 K&C allocator。 K&R allocator 的实现非常简洁，Linux 内核基于 K&R allocator 实现了用于嵌入式系统 slob allocator。见 slob: introduce the SLOB allocator，邮件摘要如下： SLOB is a traditional K&R/UNIX allocator with a SLAB emulation layer, similar to the original Linux kmalloc allocator that SLAB replaced. It's signicantly smaller code and is more memory efficient. But like all similar allocators, it scales poorly and suffers from fragmentation more than"><meta name=keywords content="Allocator,C"><meta itemprop=name content="致敬经典：K&R allocator 内存分配器"><meta itemprop=description content="k&R allocator 是Brain Kernighan和 Dennis Ritchie 的名著 The C Programming Language 第 8.7 节中介绍的一个简单 malloc 实现。因为该书被称为 K&R C，这个 malloc 实现也被称为 K&C allocator。 K&R allocator 的实现非常简洁，Linux 内核基于 K&R allocator 实现了用于嵌入式系统 slob allocator。见 slob: introduce the SLOB allocator，邮件摘要如下： SLOB is a traditional K&R/UNIX allocator with a SLAB emulation layer, similar to the original Linux kmalloc allocator that SLAB replaced. It's signicantly smaller code and is more memory efficient. But like all similar allocators, it scales poorly and suffers from fragmentation more than"><meta itemprop=datePublished content="2022-12-12T21:01:48+08:00"><meta itemprop=dateModified content="2022-12-12T21:01:48+08:00"><meta itemprop=wordCount content="2121"><meta itemprop=image content="/posts/2022/12/12/images/featured-image.png"><meta itemprop=keywords content="Allocator,C,"><meta property="og:title" content="致敬经典：K&R allocator 内存分配器"><meta property="og:description" content="k&R allocator 是Brain Kernighan和 Dennis Ritchie 的名著 The C Programming Language 第 8.7 节中介绍的一个简单 malloc 实现。因为该书被称为 K&R C，这个 malloc 实现也被称为 K&C allocator。 K&R allocator 的实现非常简洁，Linux 内核基于 K&R allocator 实现了用于嵌入式系统 slob allocator。见 slob: introduce the SLOB allocator，邮件摘要如下： SLOB is a traditional K&R/UNIX allocator with a SLAB emulation layer, similar to the original Linux kmalloc allocator that SLAB replaced. It's signicantly smaller code and is more memory efficient. But like all similar allocators, it scales poorly and suffers from fragmentation more than"><meta property="og:type" content="article"><meta property="og:url" content="/posts/2022/12/12/"><meta property="og:image" content="/posts/2022/12/12/images/featured-image.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-12-12T21:01:48+08:00"><meta property="article:modified_time" content="2022-12-12T21:01:48+08:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/posts/2022/12/12/images/featured-image.png"><meta name=twitter:title content="致敬经典：K&R allocator 内存分配器"><meta name=twitter:description content="k&R allocator 是Brain Kernighan和 Dennis Ritchie 的名著 The C Programming Language 第 8.7 节中介绍的一个简单 malloc 实现。因为该书被称为 K&R C，这个 malloc 实现也被称为 K&C allocator。 K&R allocator 的实现非常简洁，Linux 内核基于 K&R allocator 实现了用于嵌入式系统 slob allocator。见 slob: introduce the SLOB allocator，邮件摘要如下： SLOB is a traditional K&R/UNIX allocator with a SLAB emulation layer, similar to the original Linux kmalloc allocator that SLAB replaced. It's signicantly smaller code and is more memory efficient. But like all similar allocators, it scales poorly and suffers from fragmentation more than"><meta name=application-name content="FixIt"><meta name=apple-mobile-web-app-title content="FixIt"><meta name=theme-color data-light=#f8f8f8 data-dark=#252627 content="#f8f8f8"><meta name=msapplication-TileColor content="#da532c"><link rel="shortcut icon" type=image/x-icon href=/favicon.ico><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=mask-icon href=/safari-pinned-tab.svg color=#5bbad5><link rel=canonical href=/posts/2022/12/12/><link rel=prev href=/posts/2022/11/21/><link rel=stylesheet href=/css/style.min.css><link rel=stylesheet href=/lib/fontawesome-free/all.min.css><link rel=stylesheet href=/lib/animate/animate.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","headline":"致敬经典：K\u0026R allocator 内存分配器","inLanguage":"zh-CN","mainEntityOfPage":{"@type":"WebPage","@id":"\/posts\/2022\/12\/12\/"},"image":[{"@type":"ImageObject","url":"\/posts\/2022\/12\/12\/images\/featured-image.png","width":1477,"height":622}],"genre":"posts","keywords":"Allocator, C","wordcount":2121,"url":"\/posts\/2022\/12\/12\/","datePublished":"2022-12-12T21:01:48+08:00","dateModified":"2022-12-12T21:01:48+08:00","publisher":{"@type":"Organization","name":""},"author":{"@type":"Person","name":"孔俊"},"description":""}</script></head><body data-header-desktop=sticky data-header-mobile=auto><script>(window.localStorage?.getItem("theme")?localStorage.getItem("theme")==="dark":"auto"==="auto"?window.matchMedia("(prefers-color-scheme: dark)").matches:"auto"==="dark")&&document.body.setAttribute("data-theme","dark")</script><div class=wrapper data-page-style=normal><header class="desktop animate__faster" id=header-desktop><div class=header-wrapper data-github-corner=left><div class=header-title><a href=/ title=孔俊的知识库><img loading=lazy src=/logo.svg srcset="/logo.svg, /logo.svg 1.5x, /logo.svg 2x" sizes=auto data-title=孔俊的知识库 data-alt=孔俊的知识库 class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>孔俊的知识库</span></a><span class=header-subtitle></span></div><nav><ul class=menu><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/archives/>归档</a></li><li class=menu-item><a class=menu-link href=/about/>关于我</a></li><li class="menu-item delimiter"></li><li class="menu-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></li></ul></nav></div></header><header class="mobile animate__faster" id=header-mobile><div class=header-container><div class=header-wrapper><div class=header-title><a href=/ title=孔俊的知识库><img loading=lazy src=/logo.svg srcset="/logo.svg, /logo.svg 1.5x, /logo.svg 2x" sizes=auto data-title=/logo.svg data-alt=/logo.svg class=logo style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span class=header-title-text>孔俊的知识库</span></a><span class=header-subtitle></span></div><div class=menu-toggle id=menu-toggle-mobile><span></span><span></span><span></span></div></div><nav><ul class=menu id=menu-mobile><li class=menu-item><a class=menu-link href=/posts/>文章</a></li><li class=menu-item><a class=menu-link href=/categories/>分类</a></li><li class=menu-item><a class=menu-link href=/tags/>标签</a></li><li class=menu-item><a class=menu-link href=/archives/>归档</a></li><li class=menu-item><a class=menu-link href=/about/>关于我</a></li><li class="menu-item menu-system"><span class="menu-system-item theme-switch" title=切换主题><i class="fa-solid fa-adjust fa-fw" aria-hidden=true></i></span></li></ul></nav></div></header><main class=container><aside class=toc id=toc-auto><h2 class=toc-title>目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden=true></i></h2><div class=toc-content id=toc-content-auto></div></aside><aside class=aside-custom></aside><article class="page single"><div class=header><h1 class="single-title animate__animated animate__flipInX"><span title=转载 class=icon-repost><i class="fa-solid fa-share fa-fw" aria-hidden=true></i></span><span>致敬经典：K&R allocator 内存分配器</span></h1></div><div class=post-meta><div class=post-meta-line><span class=post-author><span class=author><i class="fa-solid fa-user-circle" aria-hidden=true></i>
孔俊</span></span>
<span class=post-category>收录于 <a href=/categories/allocator/><i class="fa-regular fa-folder fa-fw" aria-hidden=true></i> Allocator</a></span></div><div class=post-meta-line><span title="发布于 2022-12-12 21:01:48"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden=true></i><time datetime=2022-12-12>2022-12-12</time></span>&nbsp;<span title="更新于 2022-12-12 21:01:48"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden=true></i><time datetime=2022-12-12>2022-12-12</time></span>&nbsp;<span><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden=true></i>约 2121 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden=true></i>预计阅读 5 分钟</span>&nbsp;</div></div><div class=featured-image><img loading=lazy src=/posts/2022/12/12/images/featured-image.png srcset="/posts/2022/12/12/images/featured-image.png, /posts/2022/12/12/images/featured-image.png 1.5x, /posts/2022/12/12/images/featured-image.png 2x" sizes=auto data-title=/posts/2022/12/12/images/featured-image.png data-alt=/posts/2022/12/12/images/featured-image.png style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'></div><div class="details toc" id=toc-static data-kept=false><div class="details-summary toc-title"><span>目录</span>
<span><i class="details-icon fa-solid fa-angle-right" aria-hidden=true></i></span></div><div class="details-content toc-content" id=toc-content-static><nav id=TableOfContents><ul><li><a href=#算法>算法</a></li><li><a href=#数据结构>数据结构</a></li><li><a href=#malloc>malloc</a></li><li><a href=#free>free</a></li><li><a href=#总结>总结</a></li><li><a href=#完整代码>完整代码</a></li></ul></nav></div></div><div class=content id=content><p>k&R allocator 是<a href=https://en.wikipedia.org/wiki/Brian_Kernighan target=_blank rel="external nofollow noopener noreferrer">Brain Kernighan<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>和 <a href=https://en.wikipedia.org/wiki/Dennis_Ritchie target=_blank rel="external nofollow noopener noreferrer">Dennis Ritchie<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> 的名著 <a href=https://en.wikipedia.org/wiki/The_C_Programming_Language target=_blank rel="external nofollow noopener noreferrer"><em>The C Programming Language</em><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> 第 8.7 节中介绍的一个简单 malloc 实现。因为该书被称为 K&R C，这个 malloc 实现也被称为 K&C allocator。</p><p>K&R allocator 的实现非常简洁，Linux 内核基于 K&R allocator 实现了用于嵌入式系统 slob allocator。见 <a href=https://lwn.net/Articles/157944/ target=_blank rel="external nofollow noopener noreferrer">slob: introduce the SLOB allocator<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a>，邮件摘要如下：</p><pre tabindex=0><code>SLOB is a traditional K&amp;R/UNIX allocator with a SLAB emulation layer,
similar to the original Linux kmalloc allocator that SLAB replaced.
It&#39;s signicantly smaller code and is more memory efficient. But like
all similar allocators, it scales poorly and suffers from
fragmentation more than SLAB, so it&#39;s only appropriate for small
systems.
</code></pre><p>本文的代码摘抄自 <a href=https://en.wikipedia.org/wiki/The_C_Programming_Language target=_blank rel="external nofollow noopener noreferrer"><em>The C Programming Language</em><i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden=true></i></a> 并修改了 C99 语法错误，你可以在这里获取完整代码 <a href=/posts/2022/12/12/malloc.c>malloc.c</a>。</p><h2 id=算法>算法</h2><p>K&R allocator 用空闲链表管理其持有的内存块（block），空闲链表是一个循环链表。每个内存块都关联一个头（header），头保存了其关联的内存块地址、内存块大小以及链表的下一个节点。</p><p>逻辑结构如下图：</p><p><figure><img src=images/logical-structure-of-k-and-r-allocator.excalidraw.svg alt="图 1: K&amp;amp;R allocator 的逻辑结构"><figcaption>图 1: K&amp;amp;R allocator 的逻辑结构</figcaption></figure></p><p>在实现上，将上图的 header 和 block 合二为一，把内存起始部分作为 header。物理结构如下：</p><p><figure><img src=images/physical-structure-of-k-and-r-allocator.excalidraw.svg alt="图 2: K&amp;amp;R allocator 的物理结构"><figcaption>图 2: K&amp;amp;R allocator 的物理结构</figcaption></figure></p><p>通过<code>free()</code>中插入位置的选择，K&R allocator 维护了内存块地址递增的空闲链表。</p><h2 id=数据结构>数据结构</h2><p>header 定义如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>long</span> <span class=n>Align</span><span class=p>;</span> <span class=cm>/* for alignment to long boundary */</span>
</span></span><span class=line><span class=cl><span class=k>union</span> <span class=n>header</span> <span class=p>{</span>      <span class=cm>/* block header */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>union</span> <span class=n>header</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span> <span class=cm>/* next block if on free list */</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=n>size</span><span class=p>;</span>     <span class=cm>/* size of this block */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Align</span> <span class=n>x</span><span class=p>;</span> <span class=cm>/* force alignment of blocks */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>union</span> <span class=n>header</span> <span class=n>Header</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>Header</span> <span class=n>base</span><span class=p>;</span>          <span class=cm>/* empty list to get started */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>Header</span> <span class=o>*</span><span class=n>freep</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=cm>/* start of free list */</span>
</span></span></code></pre></div><p>header 定义为 union，利用成员<code>x</code>将 header 对齐到<code>Align</code>边界。这展示了 C 语言“以跨平台的方式编写依赖机器的代码”的能力。</p><h2 id=malloc>malloc</h2><p>分配算法如下：</p><ol><li>遍历空闲链表，查找大小不小于目标大小的内存块。</li><li>查找到，则<ol><li>若内存块大小恰好等于目标大小，从空闲链表摘除该内存块并返回。</li><li>若内存块大小不等于目标大小，分割该内存块并返回目标大小的内存。</li></ol></li><li>未查找到，则调用<code>morecore()</code>向 OS 申请不小于目标大小的内存并入空闲链表，跳转到 1 重新搜索。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* malloc: general-purpose storage allocator */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>malloc</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>nbytes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=o>*</span><span class=n>prevp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=nf>moreroce</span><span class=p>(</span><span class=kt>unsigned</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=n>nunits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>nunits</span> <span class=o>=</span> <span class=p>(</span><span class=n>nbytes</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Header</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>union</span> <span class=n>header</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>prevp</span> <span class=o>=</span> <span class=n>freep</span><span class=p>)</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* no free list yet */</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span><span class=p>.</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>freep</span> <span class=o>=</span> <span class=n>prevp</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span><span class=p>.</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>prevp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;;</span> <span class=n>prevp</span> <span class=o>=</span> <span class=n>p</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>&gt;=</span> <span class=n>nunits</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* big enough */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>==</span> <span class=n>nunits</span><span class=p>)</span> <span class=cm>/* exactly */</span>
</span></span><span class=line><span class=cl>                <span class=n>prevp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=p>{</span> <span class=cm>/* allocate tail end */</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>-=</span> <span class=n>nunits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>+=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>nunits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>freep</span> <span class=o>=</span> <span class=n>prevp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>p</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>freep</span><span class=p>)</span> <span class=cm>/* wrapped around free list */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>p</span> <span class=o>=</span> <span class=nf>morecore</span><span class=p>(</span><span class=n>nunits</span><span class=p>))</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span> <span class=cm>/* none left */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>函数<code>morecore()</code>调用<code>sbrk()</code>从 OS 获取新的堆内存，并调用<code>free()</code>（假装是这块内存是 K&R allocator 分配出来的）将其回收到空闲链表中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>Header</span> <span class=o>*</span><span class=nf>morecore</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>nu</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>cp</span><span class=p>,</span> <span class=o>*</span><span class=nf>sbrk</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=n>up</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nu</span> <span class=o>&lt;</span> <span class=n>NALLOC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>nu</span> <span class=o>=</span> <span class=n>NALLOC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cp</span> <span class=o>=</span> <span class=nf>sbrk</span><span class=p>(</span><span class=n>nu</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Header</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cp</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=cm>/* no space at all */</span>
</span></span><span class=line><span class=cl>        <span class=n>up</span> <span class=o>=</span> <span class=p>(</span><span class=n>Header</span> <span class=o>*</span><span class=p>)</span><span class=n>cp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>up</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>nu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>up</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>freep</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=free>free</h2><p><code>free()</code>算法如下：</p><ol><li>查找待回收内存块的插入位置。</li><li>将待回收内存块块插入步骤 1 查找到的插入位置。</li><li>合并相邻内存块。</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cm>/* free: put block ap in free list */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>free</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>ap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=n>bp</span><span class=p>,</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>bp</span> <span class=o>=</span> <span class=p>(</span><span class=n>Header</span> <span class=o>*</span><span class=p>)</span><span class=n>ap</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=cm>/* point to block header */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>freep</span><span class=p>;</span> <span class=o>!</span><span class=p>(</span><span class=n>bp</span> <span class=o>&gt;</span> <span class=n>p</span> <span class=o>&amp;&amp;</span> <span class=n>bp</span> <span class=o>&lt;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>);</span> <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>&gt;=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>bp</span> <span class=o>&gt;</span> <span class=n>p</span> <span class=o>||</span> <span class=n>bp</span> <span class=o>&lt;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>                         <span class=cm>/* freed block at start or end of arena */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bp</span> <span class=o>+</span> <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>==</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* join to upper nbr */</span>
</span></span><span class=line><span class=cl>        <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>+=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>+</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>==</span> <span class=n>bp</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* join to lower nbr */</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>+=</span> <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>bp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>freep</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p><code>free()</code>的关键在第一步查找插入位置，这里的查找实际上和插入排序查找插入位置是一样的。K&R 维护内存块地址单调递增的空闲链表，插入新内存块必须维持此不变量（空闲块地址递增）。</p><p>空闲链表实现为一个循环链表导致了这个简洁精巧但不易理解的<code>for</code>循环。<code>for</code>循环的条件控制理想插入位置，循环内部的<code>break</code>条件处理理想插入位置不存在的情况。空闲链表理想插入位置不存在，即插入的内存块在空闲链表的两端，插入的内存块地址最大或最小，此时当前位置在首尾衔接处。</p><p>下一个内存块地址比当前位置地址更小意味着发生了“回绕”，当前位于“首尾衔接处”。注意，必须要有<code>bp > p || bp &lt; p->s.ptr</code>的限制条件，因为<code>freep</code>可以指向空闲链表的任何位置，在头尾衔接处不意味理想插入位置不存在，还需要判断新插入内存块地址是否是空闲链表中最大/最小的。</p><p>查找到理想的插入位置后，合并相邻内存块即可。</p><h2 id=总结>总结</h2><p>K&R allocator 在算法上没有新奇之处，但是简洁的设计和精简的实现让人记忆犹新。</p><p>尤其值得注意的是，逻辑结构可以和物理结构分离。K&R allocator 逻辑上 header 和 block 分离，但物理结构上将 block 起始部分作为 header。</p><p>这种设计在 slab allocator 中也有体现，见 Jeff Bonwick 的经典论文 <em>The Slab Allocator: An Object-Caching Kernel Memory Allocator</em>。slab allocator 中，分配小对象的 slab 中<code>kmem_bufctl</code>和<code>buf</code>放到一页，大对象的 slab 中物理结构和逻辑结构相同。</p><p><figure><img src=images/logical-layout-of-kmem_slab.png alt="图 3: slab 的逻辑结构"><figcaption>图 3: slab 的逻辑结构</figcaption></figure></p><h2 id=完整代码>完整代码</h2><p>完整代码 <a href=/posts/2022/12/12/malloc.c>malloc.c</a> 如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stddef.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=kt>long</span> <span class=n>Align</span><span class=p>;</span> <span class=cm>/* for alignment to long boundary */</span>
</span></span><span class=line><span class=cl><span class=k>union</span> <span class=n>header</span> <span class=p>{</span>      <span class=cm>/* block header */</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>union</span> <span class=n>header</span> <span class=o>*</span><span class=n>ptr</span><span class=p>;</span> <span class=cm>/* next block if on free list */</span>
</span></span><span class=line><span class=cl>        <span class=kt>unsigned</span> <span class=n>size</span><span class=p>;</span>     <span class=cm>/* size of this block */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=n>s</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Align</span> <span class=n>x</span><span class=p>;</span> <span class=cm>/* force alignment of blocks */</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>typedef</span> <span class=k>union</span> <span class=n>header</span> <span class=n>Header</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>Header</span> <span class=n>base</span><span class=p>;</span>          <span class=cm>/* empty list to get started */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>Header</span> <span class=o>*</span><span class=n>freep</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span> <span class=cm>/* start of free list */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* free: put block ap in free list */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=nf>free</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>ap</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=n>bp</span><span class=p>,</span> <span class=o>*</span><span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>bp</span> <span class=o>=</span> <span class=p>(</span><span class=n>Header</span> <span class=o>*</span><span class=p>)</span><span class=n>ap</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span> <span class=cm>/* point to block header */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>freep</span><span class=p>;</span> <span class=o>!</span><span class=p>(</span><span class=n>bp</span> <span class=o>&gt;</span> <span class=n>p</span> <span class=o>&amp;&amp;</span> <span class=n>bp</span> <span class=o>&lt;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>);</span> <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>&gt;=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>&amp;&amp;</span> <span class=p>(</span><span class=n>bp</span> <span class=o>&gt;</span> <span class=n>p</span> <span class=o>||</span> <span class=n>bp</span> <span class=o>&lt;</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>))</span>
</span></span><span class=line><span class=cl>            <span class=k>break</span><span class=p>;</span>                       <span class=cm>/* freed block at start or end of arena */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>bp</span> <span class=o>+</span> <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>==</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* join to upper nbr */</span>
</span></span><span class=line><span class=cl>        <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>+=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>+</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>==</span> <span class=n>bp</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* join to lower nbr */</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>+=</span> <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>bp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>bp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>freep</span> <span class=o>=</span> <span class=n>p</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define NALLOC 1024 </span><span class=cm>/* minimum #units to request */</span><span class=cp>
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=cm>/* morecore: ask system for more memory */</span>
</span></span><span class=line><span class=cl><span class=k>static</span> <span class=n>Header</span> <span class=o>*</span><span class=nf>morecore</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>nu</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>char</span> <span class=o>*</span><span class=n>cp</span><span class=p>,</span> <span class=o>*</span><span class=nf>sbrk</span><span class=p>(</span><span class=kt>int</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=n>up</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>nu</span> <span class=o>&lt;</span> <span class=n>NALLOC</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=n>nu</span> <span class=o>=</span> <span class=n>NALLOC</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>cp</span> <span class=o>=</span> <span class=nf>sbrk</span><span class=p>(</span><span class=n>nu</span> <span class=o>*</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Header</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>cp</span> <span class=o>==</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=cm>/* no space at all */</span>
</span></span><span class=line><span class=cl>        <span class=n>up</span> <span class=o>=</span> <span class=p>(</span><span class=n>Header</span> <span class=o>*</span><span class=p>)</span><span class=n>cp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>up</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>nu</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=nf>free</span><span class=p>((</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>up</span> <span class=o>+</span> <span class=mi>1</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>freep</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cm>/* malloc: general-purpose storage allocator */</span>
</span></span><span class=line><span class=cl><span class=kt>void</span> <span class=o>*</span><span class=nf>malloc</span><span class=p>(</span><span class=kt>unsigned</span> <span class=n>nbytes</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=n>p</span><span class=p>,</span> <span class=o>*</span><span class=n>prevp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>Header</span> <span class=o>*</span><span class=nf>moreroce</span><span class=p>(</span><span class=kt>unsigned</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=kt>unsigned</span> <span class=n>nunits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>nunits</span> <span class=o>=</span> <span class=p>(</span><span class=n>nbytes</span> <span class=o>+</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>Header</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>)</span> <span class=o>/</span> <span class=k>sizeof</span><span class=p>(</span><span class=k>union</span> <span class=n>header</span><span class=p>)</span> <span class=o>+</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>((</span><span class=n>prevp</span> <span class=o>=</span> <span class=n>freep</span><span class=p>)</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* no free list yet */</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span><span class=p>.</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>freep</span> <span class=o>=</span> <span class=n>prevp</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>base</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=n>base</span><span class=p>.</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>p</span> <span class=o>=</span> <span class=n>prevp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;;</span> <span class=n>prevp</span> <span class=o>=</span> <span class=n>p</span><span class=p>,</span> <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>&gt;=</span> <span class=n>nunits</span><span class=p>)</span> <span class=p>{</span> <span class=cm>/* big enough */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>==</span> <span class=n>nunits</span><span class=p>)</span> <span class=cm>/* exactly */</span>
</span></span><span class=line><span class=cl>                <span class=n>prevp</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>ptr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>else</span> <span class=p>{</span> <span class=cm>/* allocate tail end */</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>-=</span> <span class=n>nunits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span> <span class=o>+=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>-&gt;</span><span class=n>s</span><span class=p>.</span><span class=n>size</span> <span class=o>=</span> <span class=n>nunits</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>freep</span> <span class=o>=</span> <span class=n>prevp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)(</span><span class=n>p</span> <span class=o>+</span> <span class=mi>1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>p</span> <span class=o>==</span> <span class=n>freep</span><span class=p>)</span> <span class=cm>/* wrapped around free list */</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>((</span><span class=n>p</span> <span class=o>=</span> <span class=nf>morecore</span><span class=p>(</span><span class=n>nunits</span><span class=p>))</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span> <span class=cm>/* none left */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div></div><div class=post-footer id=post-footer><div class=post-info><div class=post-info-line><div class=post-info-mod><span title="更新于 2022-12-12 21:01:48">更新于 2022-12-12&nbsp;</span></div><div class=post-info-license><span><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div></div><div class=post-info-line><div class=post-info-md></div><div class=post-info-share><span><a href=javascript:void(0); title="分享到 Twitter" data-sharer=twitter data-url=/posts/2022/12/12/ data-title="致敬经典：K&R allocator 内存分配器" data-hashtags=Allocator,C><i class="fa-brands fa-twitter fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 Facebook" data-sharer=facebook data-url=/posts/2022/12/12/ data-hashtag=Allocator><i class="fa-brands fa-facebook-square fa-fw" aria-hidden=true></i></a>
<a href=javascript:void(0); title="分享到 微博" data-sharer=weibo data-url=/posts/2022/12/12/ data-title="致敬经典：K&R allocator 内存分配器"><i class="fa-brands fa-weibo fa-fw" aria-hidden=true></i></a></span></div></div></div><div class=post-info-more><section class=post-tags><i class="fa-solid fa-tags fa-fw me-1" aria-hidden=true></i><a href=/tags/allocator/ class=post-tag>Allocator</a><a href=/tags/c/ class=post-tag>C</a></section><section><span><a href=javascript:void(0); onclick=window.history.back()>返回</a></span>&nbsp;|&nbsp;<span><a href=/>主页</a></span></section></div><div class=post-nav><a href=/posts/2022/11/21/ class=post-nav-item rel=prev title="深入剖析 Go 语言运行时：IO 轮询器"><i class="fa-solid fa-angle-left fa-fw" aria-hidden=true></i>深入剖析 Go 语言运行时：IO 轮询器</a></div></div><div class=post-reward><div class=comment></div><input type=checkbox class=reward-input name=reward id=fi-reward hidden>
<label class=reward-button for=fi-reward>赞赏</label><div class=reward-ways data-mode=static><div><img loading=lazy src=/alipay.jpg srcset="/alipay.jpg, /alipay.jpg 1.5x, /alipay.jpg 2x" sizes=auto data-title="孔俊 支付宝" data-alt="孔俊 支付宝" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span>支付宝</span></div><div><img loading=lazy src=/wechatpay.png srcset="/wechatpay.png, /wechatpay.png 1.5x, /wechatpay.png 2x" sizes=auto data-title="孔俊 微信" data-alt="孔俊 微信" style="background:url(/svg/loading.min.svg)no-repeat 50%" onload='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e);this.dataset.lazyloaded=""' onerror='this.title=this.dataset.title,this.alt=this.dataset.alt;for(const e of["style","data-title","data-alt","onerror","onload"])this.removeAttribute(e)'><span>微信</span></div></div></div><div id=comments><div id=giscus><script src=https://giscus.app/client.js data-repo=kongjun18/kongjun18.github.io data-repo-id=R_kgDOICeqmQ data-category=Announcements data-category-id=DIC_kwDOICeqmc4CVeTb data-mapping=pathname data-strict=0 data-theme=preferred_color_scheme data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-lang=zh-CN data-loading=lazy crossorigin=anonymous async defer></script></div><noscript>Please enable JavaScript to view the comments powered by <a href=https://giscus.app/ rel="external nofollow noopener noreferrer">giscus</a>.</noscript></div></article></main><footer class=footer><div class=footer-container><div class="footer-line powered">由 <a href=https://gohugo.io/ target=_blank rel="external nofollow noopener noreferrer" title="Hugo 0.110.0">Hugo</a> 强力驱动 | 主题 - <a href=https://github.com/hugo-fixit/FixIt target=_blank rel=external title="FixIt v0.2.18"><img class=fixit-icon src=/fixit.min.svg alt="FixIt logo">&nbsp;FixIt</a></div><div class="footer-line copyright" itemscope itemtype=http://schema.org/CreativeWork><i class="fa-regular fa-copyright fa-fw" aria-hidden=true></i>
<span itemprop=copyrightYear>2022 - 2023</span><span class=author itemprop=copyrightHolder>
<a href=/></a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href=https://creativecommons.org/licenses/by-nc/4.0/ target=_blank>CC BY-NC 4.0</a></span></div><div class="footer-line statistics"></div></div></footer></div><div class=widgets><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role=button aria-label=回到顶部><i class="fa-solid fa-arrow-up fa-fw" aria-hidden=true></i><span class="variant-numeric d-none">0%</span></div><div class="fixed-button view-comments d-none" role=button aria-label=查看评论><i class="fa-solid fa-comment fa-fw" aria-hidden=true></i></div></div><a href=https://github.com/kongjun18/blog title=查看博客源代码 target=_blank rel="external nofollow" class="github-corner left d-none-mobile"><svg viewBox="0 0 250 250" aria-hidden="true"><path d="M0 0 115 115h15l12 27L250 250V0z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentcolor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4l13.9-13.8C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8z" fill="currentcolor" class="octo-body"/></svg></a><div id=mask></div><noscript><div class=noscript-warning>FixIt 主题在启用 JavaScript 的情况下效果最佳。</div></noscript></div><link rel=stylesheet href=/lib/cookieconsent/cookieconsent.min.css><script src=/lib/sharer/sharer.min.js async defer></script><script src=/lib/cookieconsent/cookieconsent.min.js defer></script><script src=/lib/pangu/pangu.min.js defer></script><script>window.config={autoBookmark:!0,code:{copyTitle:"复制到剪贴板",editLockTitle:"锁定可编辑代码块",editUnLockTitle:"解锁可编辑代码块",editable:!0,maxShownLines:40},comment:{enable:!0,expired:!1,giscus:{darkTheme:"dark_dimmed",lightTheme:"light"}},cookieconsent:{content:{dismiss:"同意",link:"了解更多",message:"本网站使用 Cookies 来改善您的浏览体验。"},enable:!0,palette:{button:{background:"#f0f0f0"},popup:{background:"#1aa3ff"}},theme:"edgeless"},pangu:{enable:!0,selector:"article"}}</script><script src=/js/theme.min.js defer></script></body></html>